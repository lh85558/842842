
#!/bin/sh /etc/rc.common
# VirtualHere USB virtualization service

START=95
STOP=10

USE_PROCD=1

PROG=/usr/sbin/vhusbd
PIDFILE=/var/run/vhusbd.pid

start_service() {
    # Check if vhusbd exists
    [ -x "$PROG" ] || return 1
    
    procd_open_instance
    procd_set_param command $PROG
    procd_set_param respawn
    procd_set_param stderr 1
    procd_set_param pidfile $PIDFILE
    procd_close_instance
    
    # Allow VirtualHere port in firewall
    iptables -I INPUT -p tcp --dport 7575 -j ACCEPT 2>/dev/null || true
    iptables -I INPUT -p udp --dport 7575 -j ACCEPT 2>/dev/null || true
}

stop_service() {
    # Remove firewall rules
    iptables -D INPUT -p tcp --dport 7575 -j ACCEPT 2>/dev/null || true
    iptables -D INPUT -p udp --dport 7575 -j ACCEPT 2>/dev/null || true
}

service_triggers() {
    procd_add_reload_trigger "virtualhere"
}

reload_service() {
    stop
    start
}
